<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Job Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/@wagmi/core/dist/umd/index.min.js"></script>
</head>
<body>
  <h1>Job Marketplace</h1>
    <button id="connectWallet">Connect Wallet</button>
    <div id="walletAddress"></div>
  <h2>Post a Job</h2>
    <form id="postJobForm">
        <label>Title: <input type="text" id="title" required></label><br>
        <label>Description: <input type="text" id="description" required></label><br>
        <label>Budget (ETH): <input type="number" id="budget" required></label><br>
        <button type="submit">Post Job</button>
    </form>
  <h2>Available Jobs</h2>
    <div id="jobList">
        <p>No jobs to display yet.</p>
    </div>
  <script>
        // Viem imports (loaded from the UMD bundle above)
        const { ethersProvider, createPublicClient, createWalletClient, http, sendTransaction, utils } = wagmi;

        // Define the RPC URL for the Ethereum network (replace with your preferred network or RPC provider)
        const rpcUrl = "https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID"; // Replace with your RPC provider

        // Initialize Viem clients
        const publicClient = createPublicClient(http(rpcUrl));
        let walletClient;

        // Contract ABI and Address
        const contractAddress = "0x8ba69B9E7884cE0A920cC75a7888242014eE4DE9"; // Replace with your deployed contract address
        const abi = [
            {
                "inputs": [{ "internalType": "uint256", "name": "jobId", "type": "uint256" }],
                "name": "acceptJob",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "jobId", "type": "uint256" }],
                "name": "depositFunds",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "jobId", "type": "uint256" },
                    { "indexed": false, "internalType": "address", "name": "client", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
                ],
                "name": "FundsDeposited",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "jobId", "type": "uint256" },
                    { "indexed": false, "internalType": "address", "name": "to", "type": "address" }
                ],
                "name": "FundsReleased",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "jobId", "type": "uint256" },
                    { "indexed": false, "internalType": "address", "name": "freelancer", "type": "address" }
                ],
                "name": "JobAccepted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "jobId", "type": "uint256" },
                    { "indexed": false, "internalType": "address", "name": "client", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "budget", "type": "uint256" },
                    { "indexed": false, "internalType": "string", "name": "title", "type": "string" },
                    { "indexed": false, "internalType": "string", "name": "description", "type": "string" }
                ],
                "name": "JobPosted",
                "type": "event"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "budget", "type": "uint256" },
                    { "internalType": "string", "name": "title", "type": "string" },
                    { "internalType": "string", "name": "description", "type": "string" }
                ],
                "name": "postJob",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "jobId", "type": "uint256" }],
                "name": "releaseFunds",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": false, "internalType": "uint256", "name": "jobId", "type": "uint256" },
                    { "indexed": false, "internalType": "address", "name": "to", "type": "address" },
                    { "indexed": false, "internalType": "string", "name": "reason", "type": "string" }
                ],
                "name": "TransferFailed",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "jobCounter",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "name": "jobs",
                "outputs": [
                    { "internalType": "uint256", "name": "id", "type": "uint256" },
                    { "internalType": "address", "name": "client", "type": "address" },
                    { "internalType": "address", "name": "freelancer", "type": "address" },
                    { "internalType": "uint256", "name": "budget", "type": "uint256" },
                    { "internalType": "uint256", "name": "amountDeposited", "type": "uint256" },
                    { "internalType": "string", "name": "title", "type": "string" },
                    { "internalType": "string", "name": "description", "type": "string" },
                    { "internalType": "bool", "name": "isCompleted", "type": "bool" }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Connect Wallet
        document.getElementById("connectWallet").addEventListener("click", async () => {
            if (window.ethereum) {
                try {
                    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                    document.getElementById("walletAddress").innerText = `Connected: ${accounts[0]}`;
                    walletClient = createWalletClient({ provider: ethereum });
                } catch (error) {
                    alert("Error connecting to wallet.");
                    console.error(error);
                }
            } else {
                alert("MetaMask not found. Please install it.");
            }
        });

        // Post a Job
        document.getElementById("postJobForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("title").value;
            const description = document.getElementById("description").value;
            const budget = utils.parseEther(document.getElementById("budget").value);

            try {
                const accounts = await ethereum.request({ method: "eth_accounts" });
                const data = utils.encodeFunctionCall(abi.find(item => item.name === "postJob"), [budget, title, description]);

                await sendTransaction({
                    from: accounts[0],
                    to: contractAddress,
                    data,
                });

                alert("Job posted successfully!");
                displayStaticJobs(); // Show static jobs for simplicity
            } catch (error) {
                alert("Error posting job.");
                console.error(error);
            }
        });

        // Display Static Job List (for simplicity)
        function displayStaticJobs() {
            const jobList = document.getElementById("jobList");
            jobList.innerHTML = `
                <div>
                    <h3>Example Job</h3>
                    <p>Build a decentralized marketplace</p>
                    <p>Budget: 2 ETH</p>
                </div>
            `;
        }

        // Auto-display static job list for demo purposes
        window.addEventListener("load", displayStaticJobs);
    </script>
</body>
</html>
